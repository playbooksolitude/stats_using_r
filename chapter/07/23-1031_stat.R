#23-1031 tue 09:11

#
library(tidyverse)

#
read_delim("./dataset/07/Album Sales 1.dat") -> album1
read_delim("./dataset/07/Album Sales 2.dat") -> album2

#number ??????
album2 |> 
  mutate(num = row_number(), .before = 1) -> album2

#???????????????
lm(formula = sales ~ adverts, data = album1) -> albumsales.1
summary(albumsales.1)

lm(formula = sales ~ adverts + 
     airplay + attract, data = album2) -> albumsales.2
summary(albumsales.2)

#??? ?????? ??????
#anova 
#albumsales.1
anova(albumsales.1, albumsales.2)               #good
anova(album1, album2)                           #error
anova(albumsales.1, albumsales.2) |> summary()  #error


# ----------------------------------------------------------
#?????? ?????? 
  #??????resid()
  #??????????????? rstandard()
  #??????????????? ?????? rstudent()
  #?????? ?????? cooks.distance()
  #DFBeta dfbeta()
  #DFFit dffits()
  #????????? hatvalues()
  #???????????? covratio()

#??????
#album2 |> print(n = Inf)
#album2 |> resid() -> album2$residuals2
#albumsales.2 |> resid()
#(resid(albumsales.2) -> album2$residuals)

#?????? ?????? ????????? ??????
resid(albumsales.2) -> album2$residuals
rstandard(albumsales.2) -> album2$standardized.residuals
rstudent(albumsales.2) -> album2$studentized.residuals
cooks.distance(albumsales.2) -> album2$cooks.distance
dfbeta(albumsales.2) -> album2$dfbeta
dffits(albumsales.2) -> album2$dffits
hatvalues(albumsales.2) -> album2$leverage
covratio(albumsales.2) -> album2$covariance.ratios

#album2 |> view()
#album2 |> head() |> print(width = Inf)

write.table(album2, 
            "./dataset/07/Album Sales With Diagnostics.dat",
            sep = "\t", row.names = F)

#????????? ?????? 
album2 |> colnames()
sum(album2$standardized.residuals > 2)   #
sum(album2$standardized.residuals < -2)  #

  #????????? ?????? +2.5 | -2.5 ???????????? ???
album2$large.residual2 <- album2$standardized.residuals > 2 |
  album2$standardized.residuals < -2

album2 |> 
  filter(large.residual == T) |> 
  select(1,2,3,4,5,6,13) |> 
  view()

  #????????? ?????? +2.5 | -2.5 ???????????? ???
album2$large.residual2.5 <- 
  album2$standardized.residuals > 2.5 |
  album2$standardized.residuals < -2.5

album2 |> 
  filter(album2$large.residual2.5  == T)

  #???????????? ????????? ??? ?????????
album2[album2$large.residual2,c("cooks.distance", 
                                "leverage", 
                                "covariance.ratios")]

album2[album2$large.residual2.5,c("cooks.distance", 
                                "leverage", 
                                "covariance.ratios")]


album2[album2$large.residual2,c("num", 
                                "standardized.residuals",
                                "cooks.distance", 
                                "leverage", 
                                "covariance.ratios")]
  #?????? ????????? (k + 1)/n
    #4/200*2
    #(3+1)/200 == 0.02
  #???????????? ????????? ??????(0.04) ?????? ??????(0.06)??? ?????? ??????

  #????????? ?????? ???. ????????????
album2 |> 
  #filter(cooks.distance > 1)
  filter(leverage > 0.04) |> 
  select(num, cooks.distance, leverage, covariance.ratios)


#????????????

#dfbeta
album2 |> 
  select(num, standardized.residuals, dfbeta, dffits)

#????????? ?????? ??????
library(car)                 
albumsales.2 |> summary()
albumsales.2 |> dwt()
car::durbinWatsonTest(albumsales.2)


#??????????????? ?????? ????????? ??????
vif(albumsales.2)
car::vif
#vif(album2) error

#??????
1/vif(albumsales.2)

#?????? VIF
vif(albumsales.2) |> sum() / 3

# -----------------------------------
#????????? ?????? ??????????????? ?????? (?????????)
album2 |> colnames()
albumsales.2 |> plot()

#1 ????????? ~ ????????? ??????
ggplot(album2, 
       aes(x = leverage, 
           y = standardized.residuals)) +
  geom_point()

#fitvalue
albumsales.2$fitted.values -> album2$fitted
albumsales.2$

#2
ggplot(album2, 
       aes(x = fitted, 
           y = residuals)) +
  geom_point() +
  geom_smooth(se = F)

album2 |> colnames()
album2 |> view()

#????????? ???????????????
album2$studentized.residuals |> hist()

